using System;
using System.Collections.Generic;
using System.Data.Common;
using System.Linq;
using Microsoft.EntityFrameworkCore;
using WpfApp4.Models.Entities;
using System.ComponentModel;

namespace WpfApp4.Domain
{
    public class MyDatabaseContext : DbContext
    {
        private readonly string connectionString = null!;

        public DbSet<Пользователь> Пользователь { get; set; }
        public DbSet<Специализация> Специализация { get; set; }
        public DbSet<Врач> Врач { get; set; }
        public DbSet<Медицинская_карта> Медицинская_карта { get; set; }
        public DbSet<Запись> Запись { get; set; }
        public DbSet<Расписание> Расписание { get; set; }
        public DbSet<Отзыв> Отзыв { get; set; }

        public MyDatabaseContext(string connString)
        {
            connectionString = connString;
            Database.EnsureCreated();

            // Проверяем и заполняем базу тестовыми данными
            CheckAndSeedData();
        }

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            optionsBuilder.UseSqlite("Data Source=medicalclinic.db");
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Конфигурация таблиц (без HasData)
            modelBuilder.Entity<Пользователь>(entity =>
            {
                entity.ToTable("Пользователь");
                entity.HasKey(e => e.id);
                entity.HasIndex(e => e.email).IsUnique();
                entity.Property(e => e.роль).HasConversion<string>();
                entity.Property(e => e.дата_регистрации).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.активен).HasDefaultValue(true);
            });

            modelBuilder.Entity<Специализация>(entity =>
            {
                entity.ToTable("Специализация");
                entity.HasKey(e => e.id);
            });

            modelBuilder.Entity<Врач>(entity =>
            {
                entity.ToTable("Врач");
                entity.HasKey(e => e.id);
                entity.HasOne(e => e.Пользователь)
                      .WithOne()
                      .HasForeignKey<Врач>(e => e.пользователь_id);
                entity.HasOne(e => e.Специализация)
                      .WithMany()
                      .HasForeignKey(e => e.специализация_id);
                entity.Property(e => e.рейтинг).HasDefaultValue(0.00m);
                entity.Property(e => e.статус).HasConversion<string>().HasDefaultValue("активен");
            });

            modelBuilder.Entity<Медицинская_карта>(entity =>
            {
                entity.ToTable("Медицинская_карта");
                entity.HasKey(e => e.id);
                entity.HasOne(e => e.Пользователь)
                      .WithOne()
                      .HasForeignKey<Медицинская_карта>(e => e.пациент_id);
                entity.Property(e => e.дата_создания).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.дата_обновления).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<Запись>(entity =>
            {
                entity.ToTable("Запись");
                entity.HasKey(e => e.id);
                entity.HasOne(e => e.Пациент)
                      .WithMany()
                      .HasForeignKey(e => e.пациент_id);
                entity.HasOne(e => e.Врач)
                      .WithMany()
                      .HasForeignKey(e => e.врач_id);
                entity.Property(e => e.статус).HasConversion<string>().HasDefaultValue("запланирована");
                entity.Property(e => e.дата_создания).HasDefaultValueSql("CURRENT_TIMESTAMP");
            });

            modelBuilder.Entity<Расписание>(entity =>
            {
                entity.ToTable("Расписание");
                entity.HasKey(e => e.id);
                entity.HasOne(e => e.Врач)
                      .WithMany()
                      .HasForeignKey(e => e.врач_id);
                entity.Property(e => e.день_недели).HasConversion<string>();
                entity.Property(e => e.активен).HasDefaultValue(true);
            });

            modelBuilder.Entity<Отзыв>(entity =>
            {
                entity.ToTable("Отзыв");
                entity.HasKey(e => e.id);
                entity.HasOne(e => e.Запись)
                      .WithOne()
                      .HasForeignKey<Отзыв>(e => e.запись_id);
                entity.Property(e => e.дата_создания).HasDefaultValueSql("CURRENT_TIMESTAMP");
                entity.Property(e => e.одобрен).HasDefaultValue(false);
            });
        }

        private void CheckAndSeedData()
        {
            // Проверяем, есть ли уже данные в таблице специализаций
            if (!Специализация.Any())
            {
                System.Diagnostics.Debug.WriteLine("Заполняем базу тестовыми данными...");

                // Добавляем специализации
                var specializations = new List<Специализация>
                {
                    new Специализация { id = 1, название = "Кардиолог", описание = "Специалист по заболеваниям сердечно-сосудистой системы", категория = "Терапия" },
                    new Специализация { id = 2, название = "Невролог", описание = "Специалист по заболеваниям нервной системы", категория = "Неврология" },
                    new Специализация { id = 3, название = "Терапевт", описание = "Врач общей практики", категория = "Терапия" },
                    new Специализация { id = 4, название = "Хирург", описание = "Специалист по оперативным вмешательствам", категория = "Хирургия" },
                    new Специализация { id = 5, название = "Офтальмолог", описание = "Специалист по заболеваниям глаз", категория = "Офтальмология" },
                    new Специализация { id = 6, название = "Отоларинголог", описание = "Специалист по заболеваниям уха, горла и носа", категория = "ЛОР" },
                    new Специализация { id = 7, название = "Дерматолог", описание = "Специалист по заболеваниям кожи", категория = "Дерматология" },
                    new Специализация { id = 8, название = "Гастроэнтеролог", описание = "Специалист по заболеваниям ЖКТ", категория = "Терапия" },
                    new Специализация { id = 9, название = "Эндокринолог", описание = "Специалист по заболеваниям эндокринной системы", категория = "Терапия" },
                    new Специализация { id = 10, название = "Педиатр", описание = "Специалист по детским заболеваниям", категория = "Педиатрия" }
                };

                Специализация.AddRange(specializations);
                SaveChanges();
                System.Diagnostics.Debug.WriteLine($"Добавлено {specializations.Count} специализаций");
            }

            // Проверяем и добавляем пользователей
            if (!Пользователь.Any())
            {
                var users = new List<Пользователь>
                {
                    // Пациенты (6)
                    new Пользователь { id = 1, email = "ivan.petrov@mail.ru", пароль = "123456", роль = "пациент", имя = "Иван", фамилия = "Петров", телефон = "+79161234567", дата_рождения = new DateTime(1985, 5, 15), дата_регистрации = DateTime.Now.AddDays(-30), активен = true },
                    new Пользователь { id = 2, email = "olga.ivanova@gmail.com", пароль = "123456", роль = "пациент", имя = "Ольга", фамилия = "Иванова", телефон = "+79219876543", дата_рождения = new DateTime(1992, 3, 10), дата_регистрации = DateTime.Now.AddDays(-10), активен = true },
                    new Пользователь { id = 3, email = "sergey.sidorov@yandex.ru", пароль = "123456", роль = "пациент", имя = "Сергей", фамилия = "Сидоров", телефон = "+79031234567", дата_рождения = new DateTime(1978, 11, 25), дата_регистрации = DateTime.Now.AddDays(-45), активен = true },
                    new Пользователь { id = 4, email = "ekaterina.smirnova@mail.ru", пароль = "123456", роль = "пациент", имя = "Екатерина", фамилия = "Смирнова", телефон = "+79167654321", дата_рождения = new DateTime(1989, 7, 18), дата_регистрации = DateTime.Now.AddDays(-20), активен = true },
                    new Пользователь { id = 5, email = "dmitry.kuznetsov@gmail.com", пароль = "123456", роль = "пациент", имя = "Дмитрий", фамилия = "Кузнецов", телефон = "+79098765432", дата_рождения = new DateTime(1995, 12, 5), дата_регистрации = DateTime.Now.AddDays(-5), активен = true },
                    new Пользователь { id = 6, email = "marina.volkova@yandex.ru", пароль = "123456", роль = "пациент", имя = "Марина", фамилия = "Волкова", телефон = "+79151112233", дата_рождения = new DateTime(1982, 9, 30), дата_регистрации = DateTime.Now.AddDays(-60), активен = true },

                    // Врачи (25)
                    new Пользователь { id = 7, email = "anna.medvedeva@clinic.ru", пароль = "123456", роль = "врач", имя = "Анна", фамилия = "Медведева", телефон = "+79035554466", дата_рождения = new DateTime(1975, 4, 12), дата_регистрации = DateTime.Now.AddDays(-365), активен = true },
                    new Пользователь { id = 8, email = "alexander.popov@clinic.ru", пароль = "123456", роль = "врач", имя = "Александр", фамилия = "Попов", телефон = "+79163332211", дата_рождения = new DateTime(1980, 8, 22), дата_регистрации = DateTime.Now.AddDays(-300), активен = true },
                    new Пользователь { id = 9, email = "natalia.fedorova@clinic.ru", пароль = "123456", роль = "врач", имя = "Наталья", фамилия = "Федорова", телефон = "+79024445566", дата_рождения = new DateTime(1972, 11, 8), дата_регистрации = DateTime.Now.AddDays(-400), активен = true },
                    new Пользователь { id = 10, email = "mikhail.novikov@clinic.ru", пароль = "123456", роль = "врач", имя = "Михаил", фамилия = "Новиков", телефон = "+79167778899", дата_рождения = new DateTime(1983, 6, 14), дата_регистрации = DateTime.Now.AddDays(-200), активен = true },
                    
                    // Дополнительные врачи (15 новых)
                    new Пользователь { id = 11, email = "ekaterina.vasileva@clinic.ru", пароль = "123456", роль = "врач", имя = "Екатерина", фамилия = "Васильева", телефон = "+79160000013", дата_рождения = new DateTime(1978, 3, 15), дата_регистрации = DateTime.Now.AddDays(-150), активен = true },
                    new Пользователь { id = 12, email = "dmitry.morozov@clinic.ru", пароль = "123456", роль = "врач", имя = "Дмитрий", фамилия = "Морозов", телефон = "+79160000014", дата_рождения = new DateTime(1982, 7, 22), дата_регистрации = DateTime.Now.AddDays(-120), активен = true },
                    new Пользователь { id = 13, email = "olga.volkova@clinic.ru", пароль = "123456", роль = "врач", имя = "Ольга", фамилия = "Волкова", телефон = "+79160000015", дата_рождения = new DateTime(1975, 11, 30), дата_регистрации = DateTime.Now.AddDays(-90), активен = true },
                    new Пользователь { id = 14, email = "sergey.kozlov@clinic.ru", пароль = "123456", роль = "врач", имя = "Сергей", фамилия = "Козлов", телефон = "+79160000016", дата_рождения = new DateTime(1988, 5, 18), дата_регистрации = DateTime.Now.AddDays(-80), активен = true },
                    new Пользователь { id = 15, email = "marina.sokolova@clinic.ru", пароль = "123456", роль = "врач", имя = "Марина", фамилия = "Соколова", телефон = "+79160000017", дата_рождения = new DateTime(1980, 9, 5), дата_регистрации = DateTime.Now.AddDays(-70), активен = true },
                    new Пользователь { id = 16, email = "alexey.ivanov@clinic.ru", пароль = "123456", роль = "врач", имя = "Алексей", фамилия = "Иванов", телефон = "+79160000018", дата_рождения = new DateTime(1973, 12, 12), дата_регистрации = DateTime.Now.AddDays(-60), активен = true },
                    new Пользователь { id = 17, email = "tatyana.petrova@clinic.ru", пароль = "123456", роль = "врач", имя = "Татьяна", фамилия = "Петрова", телефон = "+79160000019", дата_рождения = new DateTime(1985, 2, 28), дата_регистрации = DateTime.Now.AddDays(-50), активен = true },
                    new Пользователь { id = 18, email = "andrey.smirnov@clinic.ru", пароль = "123456", роль = "врач", имя = "Андрей", фамилия = "Смирнов", телефон = "+79160000020", дата_рождения = new DateTime(1979, 6, 10), дата_регистрации = DateTime.Now.AddDays(-40), активен = true },
                    new Пользователь { id = 19, email = "elena.kuznetsova@clinic.ru", пароль = "123456", роль = "врач", имя = "Елена", фамилия = "Кузнецова", телефон = "+79160000021", дата_рождения = new DateTime(1983, 8, 25), дата_регистрации = DateTime.Now.AddDays(-30), активен = true },
                    new Пользователь { id = 20, email = "vladimir.vasiliev@clinic.ru", пароль = "123456", роль = "врач", имя = "Владимир", фамилия = "Васильев", телефон = "+79160000022", дата_рождения = new DateTime(1976, 4, 3), дата_регистрации = DateTime.Now.AddDays(-20), активен = true },
                    new Пользователь { id = 21, email = "irina.nikolaeva@clinic.ru", пароль = "123456", роль = "врач", имя = "Ирина", фамилия = "Николаева", телефон = "+79160000023", дата_рождения = new DateTime(1981, 10, 17), дата_регистрации = DateTime.Now.AddDays(-15), активен = true },
                    new Пользователь { id = 22, email = "pavel.mikhailov@clinic.ru", пароль = "123456", роль = "врач", имя = "Павел", фамилия = "Михайлов", телефон = "+79160000024", дата_рождения = new DateTime(1974, 1, 8), дата_регистрации = DateTime.Now.AddDays(-10), активен = true },
                    new Пользователь { id = 23, email = "natalya.egorova@clinic.ru", пароль = "123456", роль = "врач", имя = "Наталья", фамилия = "Егорова", телефон = "+79160000025", дата_рождения = new DateTime(1987, 7, 19), дата_регистрации = DateTime.Now.AddDays(-5), активен = true },
                    new Пользователь { id = 24, email = "victor.andreev@clinic.ru", пароль = "123456", роль = "врач", имя = "Виктор", фамилия = "Андреев", телефон = "+79160000026", дата_рождения = new DateTime(1972, 3, 14), дата_регистрации = DateTime.Now.AddDays(-3), активен = true },
                    new Пользователь { id = 25, email = "yulia.titova@clinic.ru", пароль = "123456", роль = "врач", имя = "Юлия", фамилия = "Титова", телефон = "+79160000027", дата_рождения = new DateTime(1984, 11, 21), дата_регистрации = DateTime.Now.AddDays(-1), активен = true },

                    // Администраторы (2)
                    new Пользователь { id = 26, email = "admin@clinic.ru", пароль = "admin123", роль = "администратор", имя = "Алексей", фамилия = "Козлов", телефон = "+79998887766", дата_рождения = new DateTime(1990, 8, 22), дата_регистрации = DateTime.Now.AddDays(-500), активен = true },
                    new Пользователь { id = 27, email = "manager@clinic.ru", пароль = "manager123", роль = "администратор", имя = "Светлана", фамилия = "Морозова", телефон = "+79997776655", дата_рождения = new DateTime(1988, 2, 28), дата_регистрации = DateTime.Now.AddDays(-350), активен = true }
                };

                Пользователь.AddRange(users);
                SaveChanges();
                System.Diagnostics.Debug.WriteLine($"Добавлено {users.Count} пользователей");
            }

            // Проверяем и добавляем врачей
            if (!Врач.Any())
            {
                var doctors = new List<Врач>
                {
                    // 19 врачей распределены по 10 специализациям
                    new Врач { id = 1, пользователь_id = 7, специализация_id = 1, лицензия = "LIC-CARD-001", страхование = "Полис ДМС №12345", программа = "Кардиологическая программа", рейтинг = 4.8m, статус = "активен" },
                    new Врач { id = 2, пользователь_id = 8, специализация_id = 3, лицензия = "LIC-THER-001", страхование = "Полис ДМС №12346", программа = "Терапевтическая программа", рейтинг = 4.6m, статус = "активен" },
                    new Врач { id = 3, пользователь_id = 9, специализация_id = 2, лицензия = "LIC-NEUR-001", страхование = "Полис ДМС №12347", программа = "Неврологическая программа", рейтинг = 4.9m, статус = "активен" },
                    new Врач { id = 4, пользователь_id = 10, специализация_id = 4, лицензия = "LIC-SURG-001", страхование = "Полис ДМС №12348", программа = "Хирургическая программа", рейтинг = 4.7m, статус = "активен" },
                    new Врач { id = 5, пользователь_id = 11, специализация_id = 5, лицензия = "LIC-OPHT-001", страхование = "Полис ДМС №12349", программа = "Офтальмологическая программа", рейтинг = 4.5m, статус = "активен" },
                    new Врач { id = 6, пользователь_id = 12, специализация_id = 6, лицензия = "LIC-ENT-001", страхование = "Полис ДМС №12350", программа = "ЛОР программа", рейтинг = 4.8m, статус = "активен" },
                    new Врач { id = 7, пользователь_id = 13, специализация_id = 7, лицензия = "LIC-DERM-001", страхование = "Полис ДМС №12351", программа = "Дерматологическая программа", рейтинг = 4.6m, статус = "активен" },
                    new Врач { id = 8, пользователь_id = 14, специализация_id = 8, лицензия = "LIC-GAST-001", страхование = "Полис ДМС №12352", программа = "Гастроэнтерологическая программа", рейтинг = 4.7m, статус = "активен" },
                    new Врач { id = 9, пользователь_id = 15, специализация_id = 9, лицензия = "LIC-ENDO-001", страхование = "Полис ДМС №12353", программа = "Эндокринологическая программа", рейтинг = 4.9m, статус = "активен" },
                    new Врач { id = 10, пользователь_id = 16, специализация_id = 10, лицензия = "LIC-PED-001", страхование = "Полис ДМС №12354", программа = "Педиатрическая программа", рейтинг = 4.8m, статус = "активен" },
                    new Врач { id = 11, пользователь_id = 17, специализация_id = 1, лицензия = "LIC-CARD-002", страхование = "Полис ДМС №12355", программа = "Кардиология повышенной сложности", рейтинг = 4.9m, статус = "активен" },
                    new Врач { id = 12, пользователь_id = 18, специализация_id = 2, лицензия = "LIC-NEUR-002", страхование = "Полис ДМС №12356", программа = "Неврология для взрослых", рейтинг = 4.7m, статус = "активен" },
                    new Врач { id = 13, пользователь_id = 19, специализация_id = 3, лицензия = "LIC-THER-002", страхование = "Полис ДМС №12357", программа = "Терапия семейная", рейтинг = 4.6m, статус = "активен" },
                    new Врач { id = 14, пользователь_id = 20, специализация_id = 4, лицензия = "LIC-SURG-002", страхование = "Полис ДМС №12358", программа = "Хирургия общая", рейтинг = 4.8m, статус = "активен" },
                    new Врач { id = 15, пользователь_id = 21, специализация_id = 5, лицензия = "LIC-OPHT-002", страхование = "Полис ДМС №12359", программа = "Офтальмология детская", рейтинг = 4.7m, статус = "активен" },
                    new Врач { id = 16, пользователь_id = 22, специализация_id = 6, лицензия = "LIC-ENT-002", страхование = "Полис ДМС №12360", программа = "ЛОР хирургия", рейтинг = 4.9m, статус = "активен" },
                    new Врач { id = 17, пользователь_id = 23, специализация_id = 7, лицензия = "LIC-DERM-002", страхование = "Полис ДМС №12361", программа = "Дерматология косметическая", рейтинг = 4.8m, статус = "активен" },
                    new Врач { id = 18, пользователь_id = 24, специализация_id = 8, лицензия = "LIC-GAST-002", страхование = "Полис ДМС №12362", программа = "Гастроэнтерология диагностика", рейтинг = 4.7m, статус = "активен" },
                    new Врач { id = 19, пользователь_id = 25, специализация_id = 9, лицензия = "LIC-ENDO-002", страхование = "Полис ДМС №12363", программа = "Эндокринология диабетология", рейтинг = 4.9m, статус = "активен" }
                };

                Врач.AddRange(doctors);
                SaveChanges();
                System.Diagnostics.Debug.WriteLine($"Добавлено {doctors.Count} врачей");
            }

            // Проверяем и добавляем медицинские карты
            if (!Медицинская_карта.Any())
            {
                var medicalCards = new List<Медицинская_карта>
                {
                    new Медицинская_карта { id = 1, пациент_id = 1, группа_крови = "A+", аллергии = "Пенициллин, аспирин", хронические_заболевания = "Гипертония 1 степени", дата_создания = DateTime.Now.AddDays(-30), дата_обновления = DateTime.Now.AddDays(-5) },
                    new Медицинская_карта { id = 2, пациент_id = 2, группа_крови = "B+", аллергии = "Нет", хронические_заболевания = "Нет", дата_создания = DateTime.Now.AddDays(-10), дата_обновления = DateTime.Now.AddDays(-10) },
                    new Медицинская_карта { id = 3, пациент_id = 3, группа_крови = "O+", аллергии = "Пыльца, шерсть животных", хронические_заболевания = "Бронхиальная астма", дата_создания = DateTime.Now.AddDays(-45), дата_обновления = DateTime.Now.AddDays(-15) },
                    new Медицинская_карта { id = 4, пациент_id = 4, группа_крови = "AB+", аллергии = "Морепродукты", хронические_заболевания = "Гастрит", дата_создания = DateTime.Now.AddDays(-20), дата_обновления = DateTime.Now.AddDays(-20) },
                    new Медицинская_карта { id = 5, пациент_id = 5, группа_крови = "A-", аллергии = "Нет", хронические_заболевания = "Нет", дата_создания = DateTime.Now.AddDays(-5), дата_обновления = DateTime.Now.AddDays(-5) },
                    new Медицинская_карта { id = 6, пациент_id = 6, группа_крови = "B-", аллергии = "Антибиотики", хронические_заболевания = "Сахарный диабет 2 типа", дата_создания = DateTime.Now.AddDays(-60), дата_обновления = DateTime.Now.AddDays(-10) }
                };

                Медицинская_карта.AddRange(medicalCards);
                SaveChanges();
                System.Diagnostics.Debug.WriteLine($"Добавлено {medicalCards.Count} медицинских карт");
            }

            System.Diagnostics.Debug.WriteLine("База данных успешно заполнена тестовыми данными!");
        }
    }
}